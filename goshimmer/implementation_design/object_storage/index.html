<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="IOTA Wiki Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="IOTA Wiki Blog Atom Feed">
<link rel="preconnect" href="${matomoUrl}">
<script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var a="https://matomo.antonionardella.it/";_paq.push(["setTrackerUrl",a+"matomo.php"]),_paq.push(["setSiteId","6"]);var e=document,t=e.createElement("script"),p=e.getElementsByTagName("script")[0];t.type="text/javascript",t.async=!0,t.src=a+"matomo.js",p.parentNode.insertBefore(t,p)}()</script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Icons">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">Object storage | IOTA Wiki</title><meta data-react-helmet="true" property="og:url" content="https://wiki.iota.org/goshimmer/implementation_design/object_storage"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-goshimmer-current"><meta data-react-helmet="true" property="og:title" content="Object storage | IOTA Wiki"><meta data-react-helmet="true" name="description" content="In GoShimmer ObjectStorage  is used as a base data structure for many data collection elements such as branchStorage, conflictStorage, messageStorage and others."><meta data-react-helmet="true" property="og:description" content="In GoShimmer ObjectStorage  is used as a base data structure for many data collection elements such as branchStorage, conflictStorage, messageStorage and others."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://wiki.iota.org/goshimmer/implementation_design/object_storage"><link data-react-helmet="true" rel="alternate" href="https://wiki.iota.org/goshimmer/implementation_design/object_storage" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://wiki.iota.org/goshimmer/implementation_design/object_storage" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.71942b32.css">
<link rel="preload" href="/assets/js/runtime~main.868fab70.js" as="script">
<link rel="preload" href="/assets/js/main.36d18f18.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" style="background-color:#ff0000;color:#fff" role="banner"><div class="announcementBarContent_3EUC">The work on this Wiki is still in progress. Consider contributing by using the in page editor or creating a <a href="https://github.com/iota-community/iota-wiki">PR directly</a></div></div><nav class="navbar navbar--fixed-top navbarHideable_1VR7"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="IOTA Wiki Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo_dark.svg" alt="IOTA Wiki Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a class="navbar__item navbar__link" href="/docs/learn/about-iota/an-introduction-to-iota">Learn</a><a class="navbar__item navbar__link" href="/docs/use/use-cases/industry-applications">Use</a><div class="navbar__item dropdown dropdown--hoverable"><a aria-current="page" class="icon-goshimmer navbar__link--active" href="/goshimmer/welcome">Develop &gt; GoShimmer Node</a><ul class="dropdown__menu"><li><a class="dropdown__link icon-getting-started" href="/docs/develop/getting-started/architecture">Getting Started</a></li><li style="font-size:10px;color:var(--ifm-color-emphasis-600);padding-top:10px">Chrysalis (IOTA 1.5)</li><li><a class="dropdown__link icon-chrysalis" href="/chrysalis-docs/welcome">Chrysalis Docs</a></li><li><a class="dropdown__link icon-bee" href="/bee/getting_started/getting_started">Bee Node</a></li><li><a class="dropdown__link icon-hornet" href="/hornet/welcome">Hornet Node</a></li><li style="font-size:10px;color:var(--ifm-color-emphasis-600);padding-top:10px">Libraries</li><li><a class="dropdown__link icon-iota-mark" href="/iota.rs/welcome">Core</a></li><li><a class="dropdown__link icon-wallet" href="/wallet.rs/welcome">Wallet</a></li><li><a class="dropdown__link icon-stronghold" href="/stronghold.rs/welcome">Stronghold</a></li><li><a class="dropdown__link icon-identity" href="/identity.rs/intro">Identity</a></li><li style="font-size:10px;color:var(--ifm-color-emphasis-600);padding-top:10px">Smart Contracts</li><li><a class="dropdown__link icon-wasp" href="/wasp/welcome">Wasp Node</a></li><li style="font-size:10px;color:var(--ifm-color-emphasis-600);padding-top:10px">Coordicide (IOTA 2.0)</li><li><a class="dropdown__link icon-iota-20" href="/IOTA-2.0-Research-Specifications/Preface">Coordicide Specs</a></li><li><a aria-current="page" class="dropdown__link icon-goshimmer dropdown__link--active" href="/goshimmer/welcome">GoShimmer Node</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/participate/support-the-network/run-a-node">Participate</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="wiki-search" role="button" tabindex="-1"><div class="wiki-search-opened"><span class="toggle_10iL" style="font-family:Material Icons">close</span></div><div class="wiki-search-closed"><span class="toggle_10iL" style="font-family:Material Icons">search</span></div><input type="checkbox" class="wiki-search-screenreader-only" aria-label="Open and close search"></div><div class="wiki-search-page"><div class="wiki-search-header"></div><div class="wiki-search-main"><div class="wiki-search-bar"><div class="wiki-search-logo"><span class="toggle_10iL" style="font-family:Material Icons">search</span></div><input class="wiki-search-input"></div></div></div><div class="react-toggle toggle_2xs0 react-toggle--checked react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3D-N" style="font-family:Material Icons">light_mode</span></div><div class="react-toggle-track-x"><span class="toggle_3D-N" style="font-family:Material Icons">dark_mode</span></div></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo sidebarWithHideableNavbar_267A"><a tabindex="-1" class="sidebarLogo_3h0W" href="/"><img src="/img/logo.svg" alt="IOTA Wiki Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/logo_dark.svg" alt="IOTA Wiki Logo" class="themedImage_1VuW themedImage--dark_hz6m"></a><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/goshimmer/welcome">Welcome</a></li><li class="menu__list-item"><a class="menu__link" href="/goshimmer/faq">FAQ</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tutorials</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Implementation design</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/goshimmer/implementation_design/event_driven_model">Event driven model</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/goshimmer/implementation_design/packages_plugins">Packages and plugins</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/goshimmer/implementation_design/plugin">Plugin</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/goshimmer/implementation_design/configuration_parameters">Configuration parameters</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/goshimmer/implementation_design/object_storage">Object storage</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Protocol Specification</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">API</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tooling</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Team Resources</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">Object storage</h1></header><p>In GoShimmer <code>ObjectStorage</code>  is used as a base data structure for many data collection elements such as <code>branchStorage</code>, <code>conflictStorage</code>, <code>messageStorage</code> and others.
It can be described by the following characteristics, it:</p><ul><li>is a manual cache which keeps objects in memory as long as consumers are using it</li><li>uses key-value storage type </li><li>provides mutex options for guarding shared variables and preventing changing the object state by multiple goroutines at the same time</li><li>takes care of  dynamic creation of different object types depending on the key, and the serialized data it receives through the utility <code>objectstorage.Factory</code></li><li>helps with the creation of multiple <code>ObjectStorage</code> instances from the same package and  automatic configuration.</li></ul><p>In order to create an object storage we need to provide the underlying <code>kvstore.KVStore</code> structure backed by the database.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="database"></a>Database<a class="hash-link" href="#database" title="Direct link to heading">#</a></h2><p>GoShimmer stores data in the form of an object storage system. The data is stored in one large repository with flat structure. It is a scalable solution that allows for fast data retrieval because of its categorization structure.</p><p>Additionally, GoShimmer leaves the possibility to store data only in memory that can be specified with the parameter <code>CfgDatabaseInMemory</code> value. In-memory storage is purely based on a Go map, package <code>mapdb</code> from hive.go.
For the persistent storage in a database it uses <code>RocksDB</code>. It is a fast key-value database that performs well for both reads and writes simultaneously that was chosen due to its low memory consumption. </p><p>Both solutions are implemented in the <code>database</code> package, along with prefix definitions that can be used during the creation of new object storage elements.</p><p>The database plugin is responsible for creating a <code>store</code> instance of the chosen database under the directory specified with <code>CfgDatabaseDir</code> parameter. It will manage a proper closure of the database upon receiving a shutdown signal. During the start configuration, the database is marked as unhealthy, and it will be marked as healthy on shutdown. Then the garbage collector is run and the database can be closed.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="objectstorage"></a>ObjectStorage<a class="hash-link" href="#objectstorage" title="Direct link to heading">#</a></h2><p>Assume we need to store data for some newly created object <code>A</code>. Then we need to define a new prefix for our package in the <code>database</code> package, and prefixes for single storage objects. They will be later used during <code>ObjectStorage</code> creation. A package prefix will be combined with a store specific prefix to create a specific realm.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Go"><pre tabindex="0" class="prism-code language-Go codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">package example</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">type Storage struct {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    A                   *objectstorage.ObjectStorage</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    shutdownOnce        sync.Once</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="objectstorage-factory"></a>ObjectStorage factory<a class="hash-link" href="#objectstorage-factory" title="Direct link to heading">#</a></h3><p>To easily create multiple storage objects instances for one package, the most convenient way is to use the factory function.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Go"><pre tabindex="0" class="prism-code language-Go codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">osFactory := objectstorage.NewFactory(store, database.Prefix)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>It needs two parameters:</p><ul><li><code>store</code> - the key value <code>kvstore</code> instance</li><li><code>database.Prefix</code> - a prefix defined in the <code>database</code> package for our new <code>example</code> package. It will be responsible for automatic configuration of the newly provided <code>kvstore</code> instance.</li></ul><p>After defining the storage factory for the group of objects, we can use it to create an <code>*objectstorage.ObjectStorage</code> instance:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Go"><pre tabindex="0" class="prism-code language-Go codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">AStorage = osFactory.New(objPrefix, FromObjectStorage)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">AStorage = osFactory.New(objPrefix, FromObjectStorage, optionalOptions...)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>For the function parameter we should provide:</p><ul><li><code>objPrefix</code> - mentioned before, we provide the object specific prefix.</li><li><code>FromObjectStorage</code> - a function that allows the dynamic creation of different object types depending on the stored data.</li><li><code>optionalOptions</code> -  an optional parameter provided in the form of options array <code>[]objectstorage.Option</code>. All possible options are defined in <code>objectstorage.Options</code>. If we do not specify them during creation, the default values will be used, such as enabled persistence or setting cache time to 0.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="storableobject"></a>StorableObject<a class="hash-link" href="#storableobject" title="Direct link to heading">#</a></h3><p><code>StorableObject</code> is an interface that allows the dynamic creation of different object types depending on the stored data. We need to make sure that all methods required by the interface are implemented to use the object storage factory.</p><ul><li><code>SetModified</code> - marks the object as modified, which will be written to the disk (if persistence is enabled).</li><li><code>IsModified</code> - returns true if the object is marked as modified</li><li><code>Delete</code> - marks the object to be deleted from the persistence layer</li><li><code>IsDeleted</code> - returns true if the object was marked as deleted</li><li><code>Persist</code> - enables or disables persistence for this object</li><li><code>ShouldPersist</code> - returns true if this object is going to be persisted</li><li><code>Update</code> - updates the object with the values of another object - requires an explicit implementation</li><li><code>ObjectStorageKey</code> - returns the key that is used to store the object in the database - requires an explicit implementation</li><li><code>ObjectStorageValue</code> - marshals the object data into a sequence of bytes that are used as the value part in the object storage - requires an explicit implementation</li></ul><p>Most of these have their default implementation in <code>objectstorage</code> library, except from <code>Update</code>, <code>ObjectStorageKey</code>, <code>ObjectStorageValue</code> which need to be provided.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="storableobjectfactory-function"></a>StorableObjectFactory function<a class="hash-link" href="#storableobjectfactory-function" title="Direct link to heading">#</a></h3><p>The function <code>ObjectFromObjectStorage</code> from object storage provides functionality to restore objects from the <code>ObjectStorage</code>. By convention the implementation of this function usually follows the schema:
<code>ObjectFromObjectStorage</code> uses <code>ObjectFromBytes</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Go"><pre tabindex="0" class="prism-code language-Go codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">func ObjectFromObjectStorage(key []byte, data []byte) (result StorableObject, err error) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    result, err := ObjectFromBytes(marshalutil.New(data))</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    return</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>ObjectFromBytes</code> unmarshals the object sequence of bytes with a help of <code>marshalutil</code> library. The returned <code>consumedBytes</code> can be used for the testing purposes.
The created <code>marshalUtil</code> instance stores the stream of bytes and keeps track of what has been already read (<code>readOffset</code>).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Go"><pre tabindex="0" class="prism-code language-Go codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">func ObjectFromBytes(bytes []byte) (object *ObjectType, consumedBytes int, err error) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    marshalUtil := marshalutil.New(bytes)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if object, err = ObjectFromMarshalUtil(marshalUtil); err != nil {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    consumedBytes = marshalUtil.ReadOffset()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    return</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The key logic is implemented in <code>ObjectFromMarshalUtil</code> that takes the marshaled object and transforms it into the object of specified type.
Because the data is stored in a sequence of bytes, it has no information about the form of an object and any data types it had before writing to the database.
Thus, we need to serialize any data into a stream of bytes in order to write it (marshaling), and deserialize the stream of bytes back into correct data structures when reading it (unmarshaling).
Let&#x27;s consider as an example, unmarshaling of the <code>Approver</code> object.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Go"><pre tabindex="0" class="prism-code language-Go codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">type Approver struct {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    approverType            ApproverType    //  8 bytes</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    referencedMessageID     MessageID       // 32 bytes</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    approverMessageID       MessageID       // 32 bytes</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The order in which we read bytes has to reflect the order in which it was written down during marshaling. As in the example, the order: <code>referencedMessageID</code>, <code>approverType</code>, <code>approverMessageID</code> is the same in both marshalling and unmarshalling.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Go"><pre tabindex="0" class="prism-code language-Go codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Unmarshalling</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">func ApproverFromMarshalUtil(marshalUtil *marshalutil.MarshalUtil) (result *Approver) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    result = &amp;Approver{}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    result.referencedMessageID = MessageIDFromMarshalUtil(marshalUtil)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    result.approverType = ApproverTypeFromMarshalUtil(marshalUtil)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    result.approverMessageID = MessageIDFromMarshalUtil(marshalUtil)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    return</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Marshalling</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">func (a *Approver) ObjectStorageApprover() []byte {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    return marshalutil.New().</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Write(a.referencedMessageID).</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Write(a.approverType).</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Write(a.approverMessageID).</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Bytes()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We continue to decompose our object into smaller pieces with help of <code>MarshalUtil</code> struct that keeps track of bytes, and a read offset.
Then we use <code>marshalutil</code> build in methods on the appropriate parts of the byte stream with its length defined by the data
type of the struct field. This way, we are able to parse bytes to the correct Go data structure.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="objectstorage-methods"></a>ObjectStorage methods<a class="hash-link" href="#objectstorage-methods" title="Direct link to heading">#</a></h3><p>After defining marshalling and unmarshalling mechanism for<code>objectStorage</code> bytes conversion,
we can start using it for its sole purpose, to actually store and read the particular parts of the project elements. </p><ul><li><p><code>Load</code> allows retrieving the corresponding object based on the provided id. For example, the method on the message <code>objectStorage</code><br>
is getting the cached object. </p></li><li><p>To convert an object retrieved in the form of a cache to its own corresponding type, we can use <code>Unwrap</code>.
In the code below it will return the message wrapped by the cached object.</p></li><li><p><code>Exists</code> - checks weather the object has been deleted. If so it is released from memory with the <code>Release</code> method.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Go"><pre tabindex="0" class="prism-code language-Go codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">func (s *Storage) Message(messageID MessageID) *CachedMessage {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    return &amp;CachedMessage{CachedObject: s.messageStorage.Load(messageID[:])}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cachedMessage := messagelayer.Tangle().Storage.Message(msgID)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if !cachedMessage.Exists() {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    msgObject.Release()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">message := cachedMessage.Unwrap()</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p><code>Consume</code> will be useful when we want to apply a function on the cached object. <code>Consume</code> unwraps the <code>CachedObject</code> and passes a type-casted version to the consumer function.
Right after the object is consumed and when the callback is finished, the object is released.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Go"><pre tabindex="0" class="prism-code language-Go codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cachedMessage.Consume(func(message *tangle.Message) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            doSomething(message)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        })</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p><code>ForEach</code> - allows to apply a <code>Consumer</code> function for every object residing within the cache and the underlying persistence layer.
For example, this is how we can count the number of messages.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Go"><pre tabindex="0" class="prism-code language-Go codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">messageCount := 0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">messageStorage.ForEach(func(key []byte, cachedObject objectstorage.CachedObject) bool {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    cachedObject.Consume(func(object objectstorage.StorableObject) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        messageCount++</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      })</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p><code>Store</code> - storing an object in the objectStorage. An extended version is method <code>StoreIfAbsent</code>
that stores an object only if it was not stored before and returns boolean indication if the object was stored.
<code>ComputeIfAbsent</code> works similarly but does not access the value log. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Go"><pre tabindex="0" class="prism-code language-Go codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cachedMessage := messageStorage.Store(newMessage)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cachedMessage, stored := messageStorage.StoreIfAbsent(newMessage)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cachedMessage := messageStorage.ComputeIfAbsent(newMessage, remappingFunction)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/goshimmer/implementation_design/configuration_parameters"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Configuration parameters</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/goshimmer/protocol_specification"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Protocol specification »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#database" class="table-of-contents__link">Database</a></li><li><a href="#objectstorage" class="table-of-contents__link">ObjectStorage</a><ul><li><a href="#objectstorage-factory" class="table-of-contents__link">ObjectStorage factory</a></li><li><a href="#storableobject" class="table-of-contents__link">StorableObject</a></li><li><a href="#storableobjectfactory-function" class="table-of-contents__link">StorableObjectFactory function</a></li><li><a href="#objectstorage-methods" class="table-of-contents__link">ObjectStorage methods</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer padding--none padding-top--xl"><div class="row footer__links padding-top--lg padding-bottom--xl"><div class="col footer__col"><h4 class="footer__title">LEARN</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/learn/about-iota/an-introduction-to-iota">About IOTA</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/learn/iota-token/overview">IOTA Token</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/learn/wallets/what-is-a-wallet">Wallets</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/learn/networks/iota-1.5-chrysalis">Networks</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/learn/resource-materials/glossary">Resource Materials</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/learn/research/research-outline">Research</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">USE</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/use/use-cases/industry-applications">Use Cases</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/use/streams/encrypted-data-comms">Streams</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/use/identity/enabling-privacy-and-trust">Identity</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/use/access/secure-access-control">Access</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/use/smart-contracts/programmable-contracts">Smart Contracts</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/use/stronghold/protecting-your-secrets">Stronghold</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/use/oracles/trust-in-real-world-data">Oracles</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/use/utilities/tangle-explorer">Utilities</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">DEVELOP</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/develop/getting-started/architecture">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/develop/fundamentals/cryptography">Fundamentals</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/develop/exchange-integration/guide">Exchange Integration</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/develop/tutorials/youtube">Tutorials</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">PARTICIPATE</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/participate/support-the-network/run-a-node">Support the network</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/participate/the-community/discord">The Community</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/participate/partnerships/iota-partnerships">Partnerships</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/participate/funding/edf-funding">Funding</a></li></ul></div></div><div class="footer__bottom padding-top--xl padding-bottom--lg"><div><a href="https://www.iota.org" target="_blank" rel="noopener noreferrer"><img src="/img/iota_logo.svg" alt="IOTA Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/img/iota_logo_dark.svg" alt="IOTA Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">© 2021 IOTA Wiki, Built with Docusaurus.</div></div><div class="socialBar_2nY3"><a class="padding-horiz--sm padding-vert--md socialLink_1As6" style="background-color:#18243C" href="https://www.youtube.com/c/iotafoundation"><img class="socialImage_2plZ" src="/img/youtube.svg"><div class="socialTitle_3JEm">Youtube</div></a><a class="padding-horiz--sm padding-vert--md socialLink_1As6" style="background-color:#24314A" href="https://www.github.com/iotaledger/"><img class="socialImage_2plZ" src="/img/github.svg"><div class="socialTitle_3JEm">GitHub</div></a><a class="padding-horiz--sm padding-vert--md socialLink_1As6" style="background-color:#303C56" href="https://discord.iota.org/"><img class="socialImage_2plZ" src="/img/discord.svg"><div class="socialTitle_3JEm">Discord</div></a><a class="padding-horiz--sm padding-vert--md socialLink_1As6" style="background-color:#3B4862" href="https://www.twitter.com/iota/"><img class="socialImage_2plZ" src="/img/twitter.svg"><div class="socialTitle_3JEm">Twitter</div></a><a class="padding-horiz--sm padding-vert--md socialLink_1As6" style="background-color:#47546F" href="https://www.reddit.com/r/iota/"><img class="socialImage_2plZ" src="/img/reddit.svg"><div class="socialTitle_3JEm">Reddit</div></a><a class="padding-horiz--sm padding-vert--md socialLink_1As6" style="background-color:#52607B" href="https://www.linkedin.com/company/iotafoundation/"><img class="socialImage_2plZ" src="/img/linkedin.svg"><div class="socialTitle_3JEm">Linkedin</div></a><a class="padding-horiz--sm padding-vert--md socialLink_1As6" style="background-color:#5E6B87" href="https://www.instagram.com/iotafoundation/"><img class="socialImage_2plZ" src="/img/instagram.svg"><div class="socialTitle_3JEm">Instagram</div></a></div></footer></div>
<script src="/assets/js/runtime~main.868fab70.js"></script>
<script src="/assets/js/main.36d18f18.js"></script>
</body>
</html>