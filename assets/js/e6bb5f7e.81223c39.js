"use strict";(self.webpackChunkiota_wiki=self.webpackChunkiota_wiki||[]).push([[96008],{56307:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return c},metadata:function(){return h},toc:function(){return d},default:function(){return f}});var o=n(74034),a=n(79973),r=(n(67294),n(3905)),i=n(31137),s=n(71871),u=["components"],l={},c="Colored Tokens and Time Locks",h={unversionedId:"guide/schema/timelock",id:"guide/schema/timelock",isDocsHomePage:!1,title:"Colored Tokens and Time Locks",description:"Let's examine some less commonly used member functions of the SoloContext. We will switch",source:"@site/external/wasp/documentation/docs/guide/schema/timelock.mdx",sourceDirName:"guide/schema",slug:"/guide/schema/timelock",permalink:"/wasp/guide/schema/timelock",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Example Tests",permalink:"/wasp/guide/schema/examples"},next:{title:"EVM/Solidity based smart contracts",permalink:"/wasp/guide/evm/introduction"}},d=[],p={toc:d};function f(e){var t=e.components,n=(0,a.Z)(e,u);return(0,r.kt)("wrapper",(0,o.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"colored-tokens-and-time-locks"},"Colored Tokens and Time Locks"),(0,r.kt)("p",null,"Let's examine some less commonly used member functions of the SoloContext. We will switch\nto the ",(0,r.kt)("inlineCode",{parentName:"p"},"fairauction")," example to show their usage. Here is the startAuction()\nfunction of the fairauction test suite:"),(0,r.kt)(i.Z,{defaultValue:"go",values:[{label:"Go",value:"go"},{label:"Rust",value:"rust"}],mdxType:"Tabs"},(0,r.kt)(s.Z,{value:"go",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'var (\n    auctioneer *wasmsolo.SoloAgent\n    tokenColor wasmlib.ScColor\n)\n\nfunc startAuction(t *testing.T) *wasmsolo.SoloContext {\n    ctx := wasmsolo.NewSoloContract(t, fairauction.ScName, fairauction.OnLoad)\n\n    // set up auctioneer account and mint some tokens to auction off\n    auctioneer = ctx.NewSoloAgent()\n    tokenColor, ctx.Err = auctioneer.Mint(10)\n    require.NoError(t, ctx.Err)\n    require.EqualValues(t, solo.Saldo-10, auctioneer.Balance())\n    require.EqualValues(t, 10, auctioneer.Balance(tokenColor))\n\n    // start the auction\n    sa := fairauction.ScFuncs.StartAuction(ctx.Sign(auctioneer))\n    sa.Params.Color().SetValue(tokenColor)\n    sa.Params.MinimumBid().SetValue(500)\n    sa.Params.Description().SetValue("Cool tokens for sale!")\n    transfer := ctx.Transfer()\n    transfer.Set(wasmlib.IOTA, 25) // deposit, must be >=minimum*margin\n    transfer.Set(tokenColor, 10) // the tokens to auction\n    sa.Func.Transfer(transfer).Post()\n    require.NoError(t, ctx.Err)\n    return ctx\n}\n')))),(0,r.kt)("p",null,"The function first sets up the SoloContext as usual, and then it performs quite a bit of\nextra work. This is because we want the startAuction() function to start an auction, so\nthat the tests that subsequently use startAuction() can then focus on testing all kinds of\nbidding and auction results."),(0,r.kt)("p",null,"First, we're going to need an agent that functions as the ",(0,r.kt)("inlineCode",{parentName:"p"},"auctioneer"),". This auctioneer\nwill auction off some colored tokens. To provide the auctioneer with colored tokens we use\nthe ",(0,r.kt)("inlineCode",{parentName:"p"},"Mint()")," method to convert 10 of his plain iota tokens into colored tokens. The mint\nprocess will assign the color value, which is equal to the hash of the Tangle transaction\nthat minted them. We save the resulting ScColor value in ",(0,r.kt)("inlineCode",{parentName:"p"},"tokenColor"),". Note that both\n",(0,r.kt)("inlineCode",{parentName:"p"},"auctioneer")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"tokenColor")," are global variables that are accessible by any test that\nneeds them."),(0,r.kt)("p",null,"Next we check that no error occurred during the minting process, and then we verify that\nthe auctioneer now has 10 less plain iota and also has a balance of 10 tokens with the\nsaved token color in its address. Notice how we use the same Balance() method to retrieve\nboth balances. When the token color parameter is omitted, the Balance() method defaults to\nreturning the balance of plain iotas in the address."),(0,r.kt)("p",null,"Now we are going to start the auction by calling the ",(0,r.kt)("inlineCode",{parentName:"p"},"startAuction")," function of the\nfairauction contract. We get the function descriptor in the usual way, but we also call\nthe ",(0,r.kt)("inlineCode",{parentName:"p"},"Sign()")," method of the SoloContext to make sure that the transaction we're about to\npost takes its tokens from the auctioneer address and signs the transaction with the\ncorresponding private key. Very often you don't care who posts a request, and we have set\nit up for you in such a way that by default tokens come from the chain originator address,\nwhich has been seeded with tokens just for this occasion. But whenever it is important\nwhere the tokens come from, or who invokes the request, you need to specify the agent\ninvolved by using the Sign() method."),(0,r.kt)("p",null,"Next we set up the function parameters as usual. Note how we pass the saved tokenColor for\nexample. After the parameters have been set up we see something new happening. We create\na ",(0,r.kt)("inlineCode",{parentName:"p"},"Transfer")," proxy and initialize it with the 25 iota that we need to deposit plus the 10\ntokens of the saved tokenColor that we are auctioning. Next we use the ",(0,r.kt)("inlineCode",{parentName:"p"},"Transfer()")," method\nto pass this proxy before posting the request. This is exactly how we would do it from\nwithin the smart contract code. We have a shorthand function called TransferIotas() that\ncan be used instead when all you need to transfer is plain iotas and which encapsulates\nthe creation of the Transfer proxy and the initialization with the required amount of\niotas."),(0,r.kt)("p",null,"Finally, we make sure there was no error while posting the request and return the\nSoloContext. That concludes the startAuction() function."),(0,r.kt)("p",null,"Here is the first test function that uses our startAuction() function:"),(0,r.kt)(i.Z,{defaultValue:"go",values:[{label:"Go",value:"go"},{label:"Rust",value:"rust"}],mdxType:"Tabs"},(0,r.kt)(s.Z,{value:"go",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func TestFaStartAuction(t *testing.T) {\n    ctx := startAuction(t)\n\n    // note 1 iota should be stuck in the delayed finalize_auction\n    require.EqualValues(t, 25-1, ctx.Balance(nil))\n    require.EqualValues(t, 10, ctx.Balance(nil, tokenColor))\n\n    // auctioneer sent 25 deposit + 10 tokenColor\n    require.EqualValues(t, solo.Saldo-25-10, auctioneer.Balance())\n    require.EqualValues(t, 0, auctioneer.Balance(tokenColor))\n    require.EqualValues(t, 0, ctx.Balance(auctioneer))\n\n    // remove pending finalize_auction from backlog\n    ctx.AdvanceClockBy(61 * time.Minute)\n    require.True(t, ctx.WaitForPendingRequests(1))\n}\n")))),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"startAuction")," function of the smart contract will have posted a time-locked request\nto the ",(0,r.kt)("inlineCode",{parentName:"p"},"finalizeAuction")," function by using the Delay() method. This request needed 1 iota\nfor the request, but the request is still 'in transit' until it is unlocked. We can verify\nthe contract balance after the transfer of 25 iota plus 10 colorToken, minus the 1 iota\nstill locked. Note how we again have an account Balance() method where the color parameter\ncan be omitted, in which case it defaults to the account balance of plain iotas."),(0,r.kt)("p",null,"We also verify the address balance of the auctioneer after sending the startAuction\nrequest. And double-check that no tokens ended up in his contract account."),(0,r.kt)("p",null,"The final 2 lines of the code are used to remove the pending ",(0,r.kt)("inlineCode",{parentName:"p"},"finalizeAuction")," request\nfrom the backlog. First we move the logical clock forward to a point when that request is\nsupposed to have triggered. Then we wait for this request to actually be processed. Note\nthat this will happen in a separate goroutine in the background, so we explicitly wait for\nthe request counters to catch up with the one request that is pending."),(0,r.kt)("p",null,"The WaitForPendingRequests() method can also be used whenever a smart contract function is\nknown to Post() a request to itself. Such requests are not immediately executed, but added\nto the backlog. So you need to wait for these pending requests to actually be processed.\nThe advantage here is that you can inspect the in-between state, which means that you can\ntest even a function that posts a request in isolation."))}f.isMDXComponent=!0},71871:function(e,t,n){var o=n(67294);t.Z=function(e){var t=e.children,n=e.hidden,a=e.className;return o.createElement("div",{role:"tabpanel",hidden:n,className:a},t)}},31137:function(e,t,n){n.d(t,{Z:function(){return d}});var o=n(74034),a=n(67294),r=n(5730),i=n(54179);var s=function(){var e=(0,a.useContext)(i.Z);if(null==e)throw new Error('"useUserPreferencesContext" is used outside of "Layout" component.');return e},u=n(29085),l=n(86010),c="tabItem_1uMI";function h(e){var t,n,o,r=e.lazy,i=e.block,h=e.defaultValue,d=e.values,p=e.groupId,f=e.className,m=a.Children.map(e.children,(function(e){if((0,a.isValidElement)(e)&&"string"==typeof e.props.value)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),v=null!=d?d:m.map((function(e){var t=e.props;return{value:t.value,label:t.label}})),k=(0,u.lx)(v,(function(e,t){return e.value===t.value}));if(k.length>0)throw new Error('Docusaurus error: Duplicate values "'+k.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.');var w=null===h?h:null!=(t=null!=h?h:null==(n=m.find((function(e){return e.props.default})))?void 0:n.props.value)?t:null==(o=m[0])?void 0:o.props.value;if(null!==w&&!v.some((function(e){return e.value===w})))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+w+'" but none of its children has the corresponding value. Available values are: '+v.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");var b=s(),g=b.tabGroupChoices,y=b.setTabGroupChoices,x=(0,a.useState)(w),T=x[0],C=x[1],N=[],q=(0,u.o5)().blockElementScrollPositionUntilNextRender;if(null!=p){var E=g[p];null!=E&&E!==T&&v.some((function(e){return e.value===E}))&&C(E)}var S=function(e){var t=e.currentTarget,n=N.indexOf(t),o=v[n].value;o!==T&&(q(t),C(o),null!=p&&y(p,o))},O=function(e){var t,n=null;switch(e.key){case"ArrowRight":var o=N.indexOf(e.currentTarget)+1;n=N[o]||N[0];break;case"ArrowLeft":var a=N.indexOf(e.currentTarget)-1;n=N[a]||N[N.length-1]}null==(t=n)||t.focus()};return a.createElement("div",{className:"tabs-container"},a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,l.Z)("tabs",{"tabs--block":i},f)},v.map((function(e){var t=e.value,n=e.label;return a.createElement("li",{role:"tab",tabIndex:T===t?0:-1,"aria-selected":T===t,className:(0,l.Z)("tabs__item",c,{"tabs__item--active":T===t}),key:t,ref:function(e){return N.push(e)},onKeyDown:O,onFocus:S,onClick:S},null!=n?n:t)}))),r?(0,a.cloneElement)(m.filter((function(e){return e.props.value===T}))[0],{className:"margin-vert--md"}):a.createElement("div",{className:"margin-vert--md"},m.map((function(e,t){return(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==T})}))))}function d(e){var t=(0,r.Z)();return a.createElement(h,(0,o.Z)({key:String(t)},e))}},54179:function(e,t,n){var o=(0,n(67294).createContext)(void 0);t.Z=o},3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return p}});var o=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var u=o.createContext({}),l=function(e){var t=o.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=l(e.components);return o.createElement(u.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,u=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=l(n),p=a,f=d["".concat(u,".").concat(p)]||d[p]||h[p]||r;return n?o.createElement(f,i(i({ref:t},c),{},{components:n})):o.createElement(f,i({ref:t},c))}));function p(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=d;var s={};for(var u in t)hasOwnProperty.call(t,u)&&(s[u]=t[u]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var l=2;l<r;l++)i[l]=n[l];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);