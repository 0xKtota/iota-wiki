"use strict";(self.webpackChunkiota_wiki=self.webpackChunkiota_wiki||[]).push([[71398],{53861:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return l},default:function(){return h},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return d}});var r=n(87462),o=n(63366),a=(n(67294),n(3905)),i=["components"],s={description:"Invoking smart contracts with on-ledger and off-ledger requests with Solo.",image:"/img/tutorial/send_request.png",keywords:["testing","PostRequestSync","PostRequestOffLedger","send","requests","post","solo","on-ledger","off-ledger"]},l="Invoking Smart Contracts",c={unversionedId:"guide/solo/invoking-sc",id:"guide/solo/invoking-sc",title:"Invoking Smart Contracts",description:"Invoking smart contracts with on-ledger and off-ledger requests with Solo.",source:"@site/content/build/wasp/develop/documentation/docs/guide/solo/invoking-sc.md",sourceDirName:"guide/solo",slug:"/guide/solo/invoking-sc",permalink:"/smart-contracts/guide/solo/invoking-sc",draft:!1,editUrl:"https://github.com/iotaledger/wasp/edit/develop/documentation/content/build/wasp/develop/documentation/docs/guide/solo/invoking-sc.md",tags:[],version:"current",frontMatter:{description:"Invoking smart contracts with on-ledger and off-ledger requests with Solo.",image:"/img/tutorial/send_request.png",keywords:["testing","PostRequestSync","PostRequestOffLedger","send","requests","post","solo","on-ledger","off-ledger"]},sidebar:"tutorialSidebar",previous:{title:"Deploying Wasm Smart Contracts",permalink:"/smart-contracts/guide/solo/deploying-sc"},next:{title:"Calling a View",permalink:"/smart-contracts/guide/solo/view-sc"}},u={},d=[{value:"Off-ledger Requests",id:"off-ledger-requests",level:2}],p={toc:d};function h(e){var t=e.components,s=(0,o.Z)(e,i);return(0,a.kt)("wrapper",(0,r.Z)({},p,s,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"invoking-smart-contracts"},"Invoking Smart Contracts"),(0,a.kt)("p",null,"After deploying our smart contract ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/iotaledger/wasp/tree/develop/documentation/tutorial-examples/src/solotutorial.rs"},(0,a.kt)("inlineCode",{parentName:"a"},"solotutorial")),", we can invoke the ",(0,a.kt)("inlineCode",{parentName:"p"},"storeString")," function:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'func TestTutorialInvokeSC(t *testing.T) {\n    env := solo.New(t, &solo.InitOptions{AutoAdjustDustDeposit: true})\n    chain := env.NewChain(nil, "ch1")\n    err := chain.DeployWasmContract(nil, "solotutorial", "solotutorial_bg.wasm")\n    require.NoError(t, err)\n\n    // invoke the `storeString` function\n    req := solo.NewCallParams("solotutorial", "storeString", "str", "Hello, world!").\n        WithMaxAffordableGasBudget()\n    _, err = chain.PostRequestSync(req, nil)\n    require.NoError(t, err)\n\n    // invoke the `getString` view\n    res, err := chain.CallView("solotutorial", "getString")\n    require.NoError(t, err)\n    require.Equal(t, "Hello, world!", codec.MustDecodeString(res.MustGet("str")))\n}\n')),(0,a.kt)("p",null,"In the above example we use ",(0,a.kt)("inlineCode",{parentName:"p"},"NewCallParams")," to set up the parameters of the request that we will send to the contract. Here we specify that we want to invoke the ",(0,a.kt)("inlineCode",{parentName:"p"},"storeString")," entry point of the ",(0,a.kt)("inlineCode",{parentName:"p"},"solotutorial")," smart contract, passing the parameter named ",(0,a.kt)("inlineCode",{parentName:"p"},"str")," with the string value ",(0,a.kt)("inlineCode",{parentName:"p"},'"Hello, world!"'),"."),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"WithMaxAffordableGasBudget")," assigns the gas budget of the request to the maximum that the sender can afford with the funds they own on L2 (including any funds attached in the request itself).\nIn this case the funds attached automatically for the storage deposit will be enough to cover for the gas fee, so it is not necessary to manually deposit more funds for gas."),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"PostRequestSync")," sends an on-ledger request to the chain. Let\u2019s describe in detail what is going on here:"),(0,a.kt)("p",null,(0,a.kt)("a",{target:"_blank",href:n(32829).Z},(0,a.kt)("img",{alt:"Generic process of posting an on-ledger request to the smart contract",src:n(5404).Z,width:"862",height:"452"}))),(0,a.kt)("p",null,"The diagram above depicts the generic process of posting an ",(0,a.kt)("em",{parentName:"p"},"on-ledger")," request to the smart contract.\nThe same diagram is valid for the Solo environment and for any other requester which sends an on-ledger request; e.g. the IOTA Smart Contracts wallet or another chain."),(0,a.kt)("p",null,"Posting an on-ledger request always consists of the steps below.\nNote that in Solo all 7 steps are carried out by the single call to ",(0,a.kt)("inlineCode",{parentName:"p"},"PostRequestSync"),"."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Creating the L1 transaction which wraps the L2 request and moves tokens.\nEach on-ledger request must be contained in a transaction on the ledger.\nTherefore, it must be signed by the private key of the sender.\nThis securely identifies each requester in IOTA Smart Contracts.\nIn Solo, the transaction is signed by the private key provided in the second parameter of the ",(0,a.kt)("inlineCode",{parentName:"li"},"PostRequestSync")," call (",(0,a.kt)("inlineCode",{parentName:"li"},"chain.OriginatorPrivateKey()")," by default)."),(0,a.kt)("li",{parentName:"ol"},"Posting the transaction to the L1 ledger and confirming it.\nIn Solo it is just adding the transaction to the emulated L1 ledger, so it is confirmed immediately and synchronously.\nThe confirmed transaction on the ledger becomes part of the backlog of requests to be processed by the chain.\nIn the real L1 ledger the sender would have to wait until the ledger confirms the transaction."),(0,a.kt)("li",{parentName:"ol"},"The chain picks the request from the backlog and runs the request on the VM."),(0,a.kt)("li",{parentName:"ol"},"The VM calls the target entry point of the smart contract program. The\nprogram updates the state."),(0,a.kt)("li",{parentName:"ol"},"The VM produces a state update transaction (the ",(0,a.kt)("em",{parentName:"li"},"anchor"),")."),(0,a.kt)("li",{parentName:"ol"},"The chain signs the transaction with its private key (the ",(0,a.kt)("inlineCode",{parentName:"li"},"chain.StateControllerKeyPair()")," in Solo)."),(0,a.kt)("li",{parentName:"ol"},"The chain posts the resulting transaction to the L1 ledger and, after confirmation, commits the corresponding state.")),(0,a.kt)("p",null,"The following lines in the test log correspond to step 7:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-log"},"49:37.771863573 INFO    TestTutorialInvokeSC    solo/solo.go:171        solo publisher: state [tgl1pzehtgythywhnhnz26s2vtpe2wy4y64pfcwkp9qvzhpwghzxhwkps2tk0nd 4 1 0-177c8a62feb7d434608215a179dd6637b8038d1237dd264\nd8feaf4d9a851b808 0000000000000000000000000000000000000000000000000000000000000000]\n49:37.771878833 INFO    TestTutorialInvokeSC    solo/solo.go:171        solo publisher: request_out [tgl1pzehtgythywhnhnz26s2vtpe2wy4y64pfcwkp9qvzhpwghzxhwkps2tk0nd 0-c55b41b07687c644b7f7a1b9fb5da86f2d40195f39885\nbc348767e2dd285ca15 4 1]\n49:37.771884127 INFO    TestTutorialInvokeSC.ch1        solo/run.go:156 state transition --\x3e #4. Requests in the block: 1. Outputs: 1\n")),(0,a.kt)("h2",{id:"off-ledger-requests"},"Off-ledger Requests"),(0,a.kt)("p",null,"Alternatively, in the example above, we could send an off-ledger request by using ",(0,a.kt)("inlineCode",{parentName:"p"},"chain.PostRequestOffLedger")," instead of ",(0,a.kt)("inlineCode",{parentName:"p"},"PostRequestSync"),".\nHowever, since off-ledger reuests cannot have tokens attached, in order to cover for the gas fee we must deposit funds to the chain beforehand:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},"user, _ := env.NewKeyPairWithFunds(env.NewSeedFromIndex(1))\nchain.DepositIotasToL2(10_000, user) // to cover gas fees\n_, err = chain.PostRequestOffLedger(req, user)\nrequire.NoError(t, err)\n")))}h.isMDXComponent=!0},32829:function(e,t,n){t.Z=n.p+"assets/files/send_request-78a4959e80ea79872674de5ba5faaa86.png"},5404:function(e,t,n){t.Z=n.p+"assets/images/send_request-78a4959e80ea79872674de5ba5faaa86.png"},3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return h}});var r=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},p=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(n),h=o,g=p["".concat(l,".").concat(h)]||p[h]||d[h]||a;return n?r.createElement(g,i(i({ref:t},u),{},{components:n})):r.createElement(g,i({ref:t},u))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var c=2;c<a;c++)i[c]=n[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"}}]);