"use strict";(self.webpackChunkiota_wiki=self.webpackChunkiota_wiki||[]).push([[67411],{78484:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return c},contentTitle:function(){return u},metadata:function(){return h},toc:function(){return p},default:function(){return d}});var a=n(74034),o=n(79973),r=(n(67294),n(3905)),i=n(31137),s=n(71871),l=["components"],c={},u="Smart Contract Initialization",h={unversionedId:"guide/schema/init",id:"guide/schema/init",isDocsHomePage:!1,title:"Smart Contract Initialization",description:"Smart contracts start out with a completely blank state. Sometimes you want to be able to",source:"@site/external/wasp/documentation/docs/guide/schema/init.mdx",sourceDirName:"guide/schema",slug:"/guide/schema/init",permalink:"/wasp/guide/schema/init",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"View-Only Functions",permalink:"/wasp/guide/schema/views"},next:{title:"Token Transfers",permalink:"/wasp/guide/schema/transfers"}},p=[],m={toc:p};function d(e){var t=e.components,n=(0,o.Z)(e,l);return(0,r.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"smart-contract-initialization"},"Smart Contract Initialization"),(0,r.kt)("p",null,"Smart contracts start out with a completely blank state. Sometimes you want to be able to\ndefine initial state, for example if your contract is configurable. You want to be able to\npass this configuration to the contract upon deployment, so that its state reflects that\nconfiguration once the first request comes in. To support this initialization we allow the\nsmart contract creator to provide an optional function named ",(0,r.kt)("inlineCode",{parentName:"p"},"init"),"."),(0,r.kt)("p",null,"This ",(0,r.kt)("inlineCode",{parentName:"p"},"init")," function, when provided, will automatically be called immediately after the\nfirst time the contract has been deployed to the VM. Note that this is a one-time\ninitialization call, meant to be performed by the contract deployment mechanism. ISCP will\nprevent anyone else from calling this function ever again. So if you need to be able to\nreconfigure the contract later on, then you will need to provide a separate configuration\nfunction, and guard it from being accessed by anyone else than properly authorized\nentities."),(0,r.kt)("p",null,"To show how creating a smart contract with WasmLib works we will slowly start fleshing out\nthe smart contract functions of the ",(0,r.kt)("inlineCode",{parentName:"p"},"dividend")," example in this tutorial. Here is the first\npart of the Rust code that implements it, which contains the 'init' function:"),(0,r.kt)(i.Z,{defaultValue:"go",values:[{label:"Go",value:"go"},{label:"Rust",value:"rust"}],mdxType:"Tabs"},(0,r.kt)(s.Z,{value:"go",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"// This example implements 'dividend', a simple smart contract that will\n// automatically disperse iota tokens which are sent to the contract to a group\n// of member addresses according to predefined division factors. The intent is\n// to showcase basic functionality of WasmLib through a minimal implementation\n// and not to come up with a complete robust real-world solution.\n// Note that we have drawn sometimes out constructs that could have been done\n// in a single line over multiple statements to be able to properly document\n// step by step what is happening in the code. We also unnecessarily annotate\n// all 'var' statements with their assignment type to improve understanding.\n\n//nolint:revive\npackage dividend\n\nimport \"github.com/iotaledger/wasp/packages/vm/wasmlib\"\n\n// 'init' is used as a way to initialize a smart contract. It is an optional\n// function that will automatically be called upon contract deployment. In this\n// case we use it to initialize the 'owner' state variable so that we can later\n// use this information to prevent non-owners from calling certain functions.\n// The 'init' function takes a single optional parameter:\n// - 'owner', which is the agent id of the entity owning the contract.\n// When this parameter is omitted the owner will default to the contract creator.\nfunc funcInit(ctx wasmlib.ScFuncContext, f *InitContext) {\n    // The schema tool has already created a proper InitContext for this function that\n    // allows us to access call parameters and state storage in a type-safe manner.\n\n    // First we set up a default value for the owner in case the optional\n    // 'owner' parameter was omitted.\n    var owner wasmlib.ScAgentID = ctx.ContractCreator()\n\n    // Now we check if the optional 'owner' parameter is present in the params map.\n    if f.Params.Owner().Exists() {\n        // Yes, it was present, so now we overwrite the default owner with\n        // the one specified by the 'owner' parameter.\n        owner = f.Params.Owner().Value()\n    }\n\n    // Now that we have sorted out which agent will be the owner of this contract\n    // we will save this value in the 'owner' variable in state storage on the host.\n    // Read the documentation on schemas to understand why this state variable is\n    // supported at compile-time by code generated by the schema tool.\n    f.State.Owner().SetValue(owner)\n}\n"))),(0,r.kt)(s.Z,{value:"rust",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},"// This example implements 'dividend', a simple smart contract that will\n// automatically disperse iota tokens which are sent to the contract to a group\n// of member addresses according to predefined division factors. The intent is\n// to showcase basic functionality of WasmLib through a minimal implementation\n// and not to come up with a complete robust real-world solution.\n// Note that we have drawn sometimes out constructs that could have been done\n// in a single line over multiple statements to be able to properly document\n// step by step what is happening in the code. We also unnecessarily annotate\n// all 'let' statements with their assignment type to improve understanding.\n\nuse wasmlib::*;\n\nuse crate::*;\n\n// 'init' is used as a way to initialize a smart contract. It is an optional\n// function that will automatically be called upon contract deployment. In this\n// case we use it to initialize the 'owner' state variable so that we can later\n// use this information to prevent non-owners from calling certain functions.\n// The 'init' function takes a single optional parameter:\n// - 'owner', which is the agent id of the entity owning the contract.\n// When this parameter is omitted the owner will default to the contract creator.\npub fn func_init(ctx: &ScFuncContext, f: &InitContext) {\n    // The schema tool has already created a proper InitContext for this function that\n    // allows us to access call parameters and state storage in a type-safe manner.\n\n    // First we set up a default value for the owner in case the optional\n    // 'owner' parameter was omitted.\n    let mut owner: ScAgentID = ctx.contract_creator();\n\n    // Now we check if the optional 'owner' parameter is present in the params map.\n    if f.params.owner().exists() {\n        // Yes, it was present, so now we overwrite the default owner with\n        // the one specified by the 'owner' parameter.\n        owner = f.params.owner().value();\n    }\n\n    // Now that we have sorted out which agent will be the owner of this contract\n    // we will save this value in the 'owner' variable in state storage on the host.\n    // Read the documentation on schemas to understand why this state variable is\n    // supported at compile-time by code generated by the schema tool.\n    f.state.owner().set_value(&owner);\n}\n")))),(0,r.kt)("p",null,"We define an owner variable and allow it to be something other than the default value of\ncontract creator. It is always a good idea to be flexible enough to be able to transfer\nownership to another entity if necessary. Remember that once a smart contract has been\ndeployed it is no longer possible to change this. Therefore, it is good practice thinking\nthrough those situations that could require change in advance and allow the contract\nitself to handle such changes through its state by providing a proper function interface:"),(0,r.kt)(i.Z,{defaultValue:"go",values:[{label:"Go",value:"go"},{label:"Rust",value:"rust"}],mdxType:"Tabs"},(0,r.kt)(s.Z,{value:"go",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"// 'setOwner' is used to change the owner of the smart contract.\n// It updates the 'owner' state variable with the provided agent id.\n// The 'setOwner' function takes a single mandatory parameter:\n// - 'owner', which is the agent id of the entity that will own the contract.\n// Only the current owner can change the owner.\nfunc funcSetOwner(ctx wasmlib.ScFuncContext, f *SetOwnerContext) {\n    // Note that the schema tool has already dealt with making sure that this function\n    // can only be called by the owner and that the required parameter is present.\n    // So once we get to this point in the code we can take that as a given.\n\n    // Save the new owner parameter value in the 'owner' variable in state storage.\n    f.State.Owner().SetValue(f.Params.Owner().Value())\n}\n"))),(0,r.kt)(s.Z,{value:"rust",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},"// 'setOwner' is used to change the owner of the smart contract.\n// It updates the 'owner' state variable with the provided agent id.\n// The 'setOwner' function takes a single mandatory parameter:\n// - 'owner', which is the agent id of the entity that will own the contract.\n// Only the current owner can change the owner.\npub fn func_set_owner(_ctx: &ScFuncContext, f: &SetOwnerContext) {\n    // Note that the schema tool has already dealt with making sure that this function\n    // can only be called by the owner and that the required parameter is present.\n    // So once we get to this point in the code we can take that as a given.\n\n    // Save the new owner parameter value in the 'owner' variable in state storage.\n    f.state.owner().set_value(&f.params.owner().value());\n}\n")))),(0,r.kt)("p",null,"Note that we only define a single owner here. Proper fall-back could require multiple\nowners in case the owner entity could disappear, which would allow others to take over\ninstead of the contract becoming immutable w.r.t. owner functionality. Again, we cannot\nstress enough how important it is to think through every aspect of a smart contract before\ndeployment."),(0,r.kt)("p",null,"In the next section we will look at how a smart contract can transfer tokens."))}d.isMDXComponent=!0},71871:function(e,t,n){var a=n(67294);t.Z=function(e){var t=e.children,n=e.hidden,o=e.className;return a.createElement("div",{role:"tabpanel",hidden:n,className:o},t)}},31137:function(e,t,n){n.d(t,{Z:function(){return p}});var a=n(74034),o=n(67294),r=n(5730),i=n(54179);var s=function(){var e=(0,o.useContext)(i.Z);if(null==e)throw new Error('"useUserPreferencesContext" is used outside of "Layout" component.');return e},l=n(29085),c=n(86010),u="tabItem_1uMI";function h(e){var t,n,a,r=e.lazy,i=e.block,h=e.defaultValue,p=e.values,m=e.groupId,d=e.className,w=o.Children.map(e.children,(function(e){if((0,o.isValidElement)(e)&&"string"==typeof e.props.value)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),f=null!=p?p:w.map((function(e){var t=e.props;return{value:t.value,label:t.label}})),v=(0,l.lx)(f,(function(e,t){return e.value===t.value}));if(v.length>0)throw new Error('Docusaurus error: Duplicate values "'+v.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.');var b=null===h?h:null!=(t=null!=h?h:null==(n=w.find((function(e){return e.props.default})))?void 0:n.props.value)?t:null==(a=w[0])?void 0:a.props.value;if(null!==b&&!f.some((function(e){return e.value===b})))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+b+'" but none of its children has the corresponding value. Available values are: '+f.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");var g=s(),y=g.tabGroupChoices,k=g.setTabGroupChoices,x=(0,o.useState)(b),T=x[0],O=x[1],N=[],S=(0,l.o5)().blockElementScrollPositionUntilNextRender;if(null!=m){var C=y[m];null!=C&&C!==T&&f.some((function(e){return e.value===C}))&&O(C)}var I=function(e){var t=e.currentTarget,n=N.indexOf(t),a=f[n].value;a!==T&&(S(t),O(a),null!=m&&k(m,a))},E=function(e){var t,n=null;switch(e.key){case"ArrowRight":var a=N.indexOf(e.currentTarget)+1;n=N[a]||N[0];break;case"ArrowLeft":var o=N.indexOf(e.currentTarget)-1;n=N[o]||N[N.length-1]}null==(t=n)||t.focus()};return o.createElement("div",{className:"tabs-container"},o.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,c.Z)("tabs",{"tabs--block":i},d)},f.map((function(e){var t=e.value,n=e.label;return o.createElement("li",{role:"tab",tabIndex:T===t?0:-1,"aria-selected":T===t,className:(0,c.Z)("tabs__item",u,{"tabs__item--active":T===t}),key:t,ref:function(e){return N.push(e)},onKeyDown:E,onFocus:I,onClick:I},null!=n?n:t)}))),r?(0,o.cloneElement)(w.filter((function(e){return e.props.value===T}))[0],{className:"margin-vert--md"}):o.createElement("div",{className:"margin-vert--md"},w.map((function(e,t){return(0,o.cloneElement)(e,{key:t,hidden:e.props.value!==T})}))))}function p(e){var t=(0,r.Z)();return o.createElement(h,(0,a.Z)({key:String(t)},e))}},54179:function(e,t,n){var a=(0,n(67294).createContext)(void 0);t.Z=a},3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return m}});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(n),m=o,d=p["".concat(l,".").concat(m)]||p[m]||h[m]||r;return n?a.createElement(d,i(i({ref:t},u),{},{components:n})):a.createElement(d,i({ref:t},u))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var c=2;c<r;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"}}]);