"use strict";(self.webpackChunkiota_wiki=self.webpackChunkiota_wiki||[]).push([[86971],{75884:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return c},contentTitle:function(){return u},metadata:function(){return d},toc:function(){return m},default:function(){return h}});var a=n(74034),r=n(79973),o=(n(67294),n(3905)),i=n(31137),s=n(71871),l=["components"],c={},u="Testing Smart Contracts",d={unversionedId:"guide/schema/test",id:"guide/schema/test",isDocsHomePage:!1,title:"Testing Smart Contracts",description:"Testing of smart contracts initially happens in the Solo testing environment. This enables",source:"@site/external/wasp/documentation/docs/guide/schema/test.mdx",sourceDirName:"guide/schema",slug:"/guide/schema/test",permalink:"/wasp/guide/schema/test",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Posting Asynchronous Requests",permalink:"/wasp/guide/schema/post"},next:{title:"Example Tests",permalink:"/wasp/guide/schema/examples"}},m=[],p={toc:m};function h(e){var t=e.components,n=(0,r.Z)(e,l);return(0,o.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"testing-smart-contracts"},"Testing Smart Contracts"),(0,o.kt)("p",null,"Testing of smart contracts initially happens in the Solo testing environment. This enables\nsynchronous, deterministic testing of smart contract functionality without the overhead of\nhaving to start nodes, set up a committee, and send transactions over the Tangle. Instead,\nwe can use Go's built-in test environment in combination with Solo to deploy chains and\nsmart contracts and simulate transactions."),(0,o.kt)("p",null,"Solo directly interacts with the ISCP code and uses all the data types that are\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/iotaledger/wasp/blob/develop/documentation/docs/misc/coretypes.md"},"defined in the ISCP code"),"\ndirectly. But our Wasm smart contracts cannot access these types directly because they run\nin a sandboxed environment. Therefore, WasmLib implements its\n",(0,o.kt)("a",{parentName:"p",href:"/wasp/guide/schema/types"},"own versions")," of these data types and the VM layer acts as a data type\ntranslator between both systems."),(0,o.kt)("p",null,"The impact of this type transformation used to be that to be able to write tests in the\nsolo environment the user also needed to know about the ISCP-specific data types and type\nconversion functions, and exactly how to properly pass such data in and out of smart\ncontract function calls. This burdened the user with an unnecessary increased learning\ncurve."),(0,o.kt)("p",null,"With the introduction of the schema tool we were able to remove this impedance mismatch\nand allow the user to test smart contract functionality in terms of the WasmLib data types\nand functions that he is already familiar with. To that end we introduced a new ISCP\nfunction context that specifically works with the Solo testing environment. We aimed to\nsimplify the testing of smart contracts as much as possible, keeping the full Solo\ninterface hidden as much as possible, yet available when necessary."),(0,o.kt)("p",null,"The only concession we still have to make is to the language used. Because Solo only works\nin the Go language environment, we have to use the Go language version of the interface\ncode that the schema tool generates when testing our smart contracts. We feel that this is\nnot unsurmountable, because WasmLib programming for Rust and Go are practically identical.\nThey only differ where language idiosyncrasies force differences in syntax or naming\nconventions. This hurdle used to be a lot bigger before, when direct programming of Solo\nhad to be used, and type conversions had to be done manually. Instead, we now get to use\nthe generated compile-time type-checked interface to our smart contract functions that we\nare already familiar with."),(0,o.kt)("p",null,"Let's look at the simplest way of initializing a smart contract by using the new\n",(0,o.kt)("inlineCode",{parentName:"p"},"SoloContext")," in a test function:"),(0,o.kt)(i.Z,{defaultValue:"go",values:[{label:"Go",value:"go"}],mdxType:"Tabs"},(0,o.kt)(s.Z,{value:"go",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},"func TestDeploy(t *testing.T) {\n    ctx := wasmsolo.NewSoloContext(t, dividend.ScName, dividend.OnLoad)\n    require.NoError(t, ctx.ContractExists(dividend.ScName))\n}\n")))),(0,o.kt)("p",null,"The first line will automatically create a new chain and upload and deploy the provided\nexample ",(0,o.kt)("inlineCode",{parentName:"p"},"dividend")," contract to this chain. It returns a ",(0,o.kt)("inlineCode",{parentName:"p"},"SoloContext")," for further use. The\nsecond line verifies the existence of the deployed contract on the chain associated with\nthe context."),(0,o.kt)("p",null,"Here is another part of the ",(0,o.kt)("inlineCode",{parentName:"p"},"dividend")," test code, where you can see how we wrap repetitive\ncalls to smart contract functions that are used in multiple tests:"),(0,o.kt)(i.Z,{defaultValue:"go",values:[{label:"Go",value:"go"}],mdxType:"Tabs"},(0,o.kt)(s.Z,{value:"go",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},"func dividendMember(ctx *wasmsolo.SoloContext, agent *wasmsolo.SoloAgent, factor int64) {\n    member := dividend.ScFuncs.Member(ctx)\n    member.Params.Address().SetValue(agent.ScAddress())\n    member.Params.Factor().SetValue(factor)\n    member.Func.TransferIotas(1).Post()\n}\n\nfunc dividendDivide(ctx *wasmsolo.SoloContext, amount int64) {\n    divide := dividend.ScFuncs.Divide(ctx)\n    divide.Func.TransferIotas(amount).Post()\n}\n\nfunc dividendGetFactor(ctx *wasmsolo.SoloContext, member3 *wasmsolo.SoloAgent) int64 {\n    getFactor := dividend.ScFuncs.GetFactor(ctx)\n    getFactor.Params.Address().SetValue(member3.ScAddress())\n    getFactor.Func.Call()\n    value := getFactor.Results.Factor().Value()\n    return value\n}\n")))),(0,o.kt)("p",null,"As you can see we pass in the SoloContext and the parameters to the wrapper functions,\nthen use the context to create a function descriptor for the wrapped function, pass any\nparameters through the ",(0,o.kt)("inlineCode",{parentName:"p"},"Params")," proxy, and then either post the function request or call\nthe function. Any results returned are extracted through the ",(0,o.kt)("inlineCode",{parentName:"p"},"Results")," proxy and returned\nby the wrapper."),(0,o.kt)("p",null,"As you can see there is literally no difference in the way the function interface is used\nwith the ISCP function context in WasmLib and with the SoloContext. This makes for\nseamless testing of smart contracts"),(0,o.kt)("p",null,"In the next section we will go deeper into how the helper member functions of the\nSoloContext are used to simplify tests."))}h.isMDXComponent=!0},71871:function(e,t,n){var a=n(67294);t.Z=function(e){var t=e.children,n=e.hidden,r=e.className;return a.createElement("div",{role:"tabpanel",hidden:n,className:r},t)}},31137:function(e,t,n){n.d(t,{Z:function(){return m}});var a=n(74034),r=n(67294),o=n(5730),i=n(54179);var s=function(){var e=(0,r.useContext)(i.Z);if(null==e)throw new Error('"useUserPreferencesContext" is used outside of "Layout" component.');return e},l=n(29085),c=n(86010),u="tabItem_1uMI";function d(e){var t,n,a,o=e.lazy,i=e.block,d=e.defaultValue,m=e.values,p=e.groupId,h=e.className,f=r.Children.map(e.children,(function(e){if((0,r.isValidElement)(e)&&"string"==typeof e.props.value)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),v=null!=m?m:f.map((function(e){var t=e.props;return{value:t.value,label:t.label}})),y=(0,l.lx)(v,(function(e,t){return e.value===t.value}));if(y.length>0)throw new Error('Docusaurus error: Duplicate values "'+y.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.');var g=null===d?d:null!=(t=null!=d?d:null==(n=f.find((function(e){return e.props.default})))?void 0:n.props.value)?t:null==(a=f[0])?void 0:a.props.value;if(null!==g&&!v.some((function(e){return e.value===g})))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+g+'" but none of its children has the corresponding value. Available values are: '+v.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");var b=s(),w=b.tabGroupChoices,k=b.setTabGroupChoices,x=(0,r.useState)(g),T=x[0],S=x[1],C=[],O=(0,l.o5)().blockElementScrollPositionUntilNextRender;if(null!=p){var N=w[p];null!=N&&N!==T&&v.some((function(e){return e.value===N}))&&S(N)}var E=function(e){var t=e.currentTarget,n=C.indexOf(t),a=v[n].value;a!==T&&(O(t),S(a),null!=p&&k(p,a))},P=function(e){var t,n=null;switch(e.key){case"ArrowRight":var a=C.indexOf(e.currentTarget)+1;n=C[a]||C[0];break;case"ArrowLeft":var r=C.indexOf(e.currentTarget)-1;n=C[r]||C[C.length-1]}null==(t=n)||t.focus()};return r.createElement("div",{className:"tabs-container"},r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,c.Z)("tabs",{"tabs--block":i},h)},v.map((function(e){var t=e.value,n=e.label;return r.createElement("li",{role:"tab",tabIndex:T===t?0:-1,"aria-selected":T===t,className:(0,c.Z)("tabs__item",u,{"tabs__item--active":T===t}),key:t,ref:function(e){return C.push(e)},onKeyDown:P,onFocus:E,onClick:E},null!=n?n:t)}))),o?(0,r.cloneElement)(f.filter((function(e){return e.props.value===T}))[0],{className:"margin-vert--md"}):r.createElement("div",{className:"margin-vert--md"},f.map((function(e,t){return(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==T})}))))}function m(e){var t=(0,o.Z)();return r.createElement(d,(0,a.Z)({key:String(t)},e))}},54179:function(e,t,n){var a=(0,n(67294).createContext)(void 0);t.Z=a},3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return p}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=c(n),p=r,h=m["".concat(l,".").concat(p)]||m[p]||d[p]||o;return n?a.createElement(h,i(i({ref:t},u),{},{components:n})):a.createElement(h,i({ref:t},u))}));function p(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"}}]);